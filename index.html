<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="http://www.facebook.com/2008/fbml"
    itemscope itemtype="http://schema.org/WebPage">
<head>
    <meta charset="utf-16">
    <title>The Office</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <meta property="og:type" content="website">
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <meta property="og:site_name" content="">

    <meta name="git:tag" content="@@tag">
    <meta name="git:rev" content="@@rev">
    <meta name="git:date" content="@@date">

    <meta name="viewport" content="width=600">

    <meta name="apple-mobile-web-app-capable" content="no">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="app.css">
</head>
<body>
    <section id="status">THE OFFICE</section>
    <section id="users"><video id="myvideo" muted autoplay></video><img id="mypic" /></section>
    <div id="container"><div id="chatbox"></div></div>
    <div id="controls">
        <input id="msg" type="text" placeholder="Chat message" />
    </div>
    <canvas id="photo" style="display: none;" width="320" height="240"></canvas>
    <audio id="alert" src="beepbeep.mp3" style="display: none;"></audio>

    <!--<script type="text/javascript" src="//l2.io/ip.js?var=myip"></script>-->
    <script type="text/javascript" src="//cdn.temasys.com.sg/skylink/skylinkjs/0.5.x/skylink.complete.min.js"></script>
    <script type="text/javascript" src="helpers.js"></script>
    <script type="text/javascript">

    var skylink = new Skylink(),
        $video = document.getElementById('myvideo'),
        $pic = document.getElementById('mypic'),
        $users = document.getElementById('users'),
        $msg = document.getElementById('msg'),
        $chatbox = document.getElementById('chatbox'),
        $photo = document.getElementById('photo'),
        $alert = document.getElementById('alert'),
        user = {},
        peer_pics = [],
        last_pic = null,
        capture_timeout = null;

    var online = false,
        focussed = true,
        mediaOK = false;

    skylink.setLogLevel(skylink.LOG_LEVEL.DEBUG);
    skylink.setDebugMode(true);

    skylink.on('incomingStream', function (peerId, stream, isSelf) {
        if(isSelf) {
            attachMediaStream($video, stream);
        }
        else {
            var $vid = document.createElement('video');
            $vid.id = "vid_" + peerId;
            $vid.autoplay = true;
            vid.onclick = function() {
                skylink.sendMessage('/hangup');
            };
            $users.replaceChild("img_" + peerId, $vid);
        }
    });

    skylink.on('incomingMessage', function (message, peerId, peerInfo, isSelf) {
        if(message.content.substr(0,1) === '/') {
            var msg = message.content.substr(1);
            if(msg === 'hail') {
                $alert.play();
                var $img = document.getElementById("img_" + peerId);
                $img.className = "hailing";
                setTimeout(function () {
                   $img.className = "";
                }, 5000);
            }
            else if(msg.substr(0,8) === 'getaroom') {
                addMessage('<a href="http://getaroom.io/' + msg.substr(9) + '" target="_blank">Get a room</a>', 'action', isSelf ? msg.substr(9) : peerId);
            }
            else if(msg === 'hangup') {
                skylink._stopLocalMediaStreams();
                var $img = addUserImage(peerId);
                $users.replaceChild("vid_" + peerId, $img);
            }
        }
        else {
            addMessage(message.content, "message", peerId, isSelf);
        }
    });

    skylink.on('dataTransferState', function (state, transferId, peerId, transferInfo, error) {
        if(state === skylink.DATA_TRANSFER_STATE.UPLOAD_REQUEST) {
            skylink.respondBlobRequest(peerId, true);
            console.log("Incoming Request from " + peerId);
        }
        else if(state === skylink.DATA_TRANSFER_STATE.DOWNLOAD_COMPLETED) {
            console.log("Download completed from " + peerId);
            var $img = document.getElementById("img_" + peerId);

            var data = URL.createObjectURL(transferInfo.data);
            peer_pics[peerId] = data;

            if(!$img) {
                var info = skylink.getPeerInfo(peerId);
                $img = addUserImage(peerId, info.userData.name);
                addMessage(info.userData.name + ' is in the office', 'action', peerId, false);
            }

            $img.src = data;
        }
        else if(error && error.message) {
            console.log(error.message);
        }
    });

    skylink.on('dataChannelState', function (state, peerId) {
        if(state == skylink.DATA_CHANNEL_STATE.OPEN) {

        }
    });

    skylink.on('mediaAccessSuccess', function (stream) {
        attachMediaStream($video, stream);
        capture_timeout = setTimeout(capture, 2000);
        addMessage("Thanks. May I now know your name?", 'bot');
        $msg.select();
        mediaOK = true;
    });

    skylink.on('mediaAccessError', function (stream) {
        addMessage("Sorry, I can't let you in like this.", 'bot');
    });

    skylink.on('readyStateChange', function(state) {
        if(state === 2) {

        }
    });

    skylink.on('peerJoined', function (peerId, peerInfo, isSelf) {
        if(isSelf) {
            online = true;
            addMessage('Welcome to the office, ' + user.name + '.', 'bot');
            skylink.setUserData(user);
        }
    });

    skylink.on('peerLeft', function (peerId, peerInfo, isSelf) {
        if(isSelf) {
            online = false;
            addMessage('Bye', 'bot');
        }
        else {
            var $img = document.getElementById("img_" + peerId);
            var $span = document.getElementById("span_" + peerId);
            $users.removeChild($img);
            $users.removeChild($span);
            addMessage(peerInfo.userData.name + ' left the office', 'action', peerId, false);
        }
    });

    skylink.init({
        apiKey: '774b477f-dc20-4374-ba13-3eda09414c28',
        defaultRoom: ''
    }, function() {
        skylink.getUserMedia({video: {
            resolution: {
                width: 320,
                height: 240
            }
        }, audio: false});
        addMessage("Hey. I\'m the office security. Please share your camera so I can see you.", 'bot');
    });

    function addUserImage(peerId, name) {
        var $img = document.createElement('img');
        $img.id = "img_" + peerId;
        $users.appendChild($img);

        var $span = document.createElement('span');
        $span.id = "span_" + peerId;
        $span.textContent = name;

        $span.onclick = function() {
            skylink.sendMessage('/hail', peerId);
            $img.className = "hailing";
            setTimeout(function () {
               $img.className = "";
               /*skylink.sendStream({video: {
                    width: 320,
                    height: 240
               }, audio: true});*/
            }, 5000);
            console.log("Hailing " + peerId);
        }
        $span.ondblclick = function () {
            skylink.sendMessage('/getaroom ' + peerId, peerId);
            console.log("Get a room invite to " + peerId);
        }

        $users.appendChild($span);

        return $img;
    }

    function sendMessage() {
      skylink.sendP2PMessage($msg.value);
    }

    function addMessage(message, className, peerId, isSelf) {
        var $div = document.createElement('div');
        $div.className = className;
        $chatbox.appendChild($div);

        var $img = document.createElement('img');
        if(className === 'bot') {
            $img.src = 'bot.png';
        }
        else {
            $img.src = isSelf ? last_pic : peer_pics[peerId];
        }
        $div.appendChild($img);

        var $span = document.createElement('span');
        if(className === 'action') {
            $span.innerHTML = message;
        }
        else {
            $span.textContent = message;
        }
        $div.appendChild($span);
    }

    function capture() {
        clearTimeout(capture_timeout);

        var ctx = $photo.getContext("2d");
        ctx.drawImage($video, 0, 0, 320, 240);

        if(!focussed) {
            stackBlurCanvasRGB(ctx, 0, 0, 320, 240, 35);
        }

        last_pic = $photo.toDataURL('image/jpeg', 0.8);

        $pic.src = last_pic;

        var blob = dataURL2Blob(last_pic);

        skylink.sendBlobData(blob, {
            size: blob.size,
            name: (new Date()).toString()
        });

        capture_timeout = setTimeout(capture, 5000);
    }

    $msg.onkeydown = function(e) {
        if(e.keyCode === 13 && mediaOK) {
            if(online) {
                sendMessage();
            }
            else if(!user.name) {
                user.name = $msg.value;
                skylink.joinRoom();
            }
            $msg.value = '';
            $msg.select();
        }
    }

    $pic.onclick = function() {
        capture();
    }

    window.onfocus = function () {
        focussed = true;
        capture();
        $msg.select();
    }

    window.onblur = function() {
        focussed = false;
        capture();
    }

    </script>

</body>
</html>
