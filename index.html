<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="http://www.facebook.com/2008/fbml"
    itemscope itemtype="http://schema.org/WebPage">
<head>
    <meta charset="utf-16">
    <title>coworking</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <meta property="og:type" content="website">
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <meta property="og:site_name" content="">

    <meta name="git:tag" content="@@tag">
    <meta name="git:rev" content="@@rev">
    <meta name="git:date" content="@@date">

    <meta name="viewport" content="width=600">

    <meta name="apple-mobile-web-app-capable" content="no">
    <meta name="mobile-web-app-capable" content="yes">
    <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="app.css">
</head>
<body>
    <div id="app">
        <section id="users"><video id="myvideo" muted autoplay></video><img id="mypic" /></section>
        <div id="chatcontainer"><div><div id="chatbox"></div></div></div>
        <div id="controls">
            <textarea id="msg" placeholder="Chat message"></textarea>
        </div>
    </div>

    <canvas id="photo" style="display: none;" width="160" height="120"></canvas>
    <audio id="alert" src="beepbeep.mp3" style="display: none;"></audio>

    <!--<script type="text/javascript" src="//l2.io/ip.js?var=myip"></script>-->
    <script type="text/javascript" src="//cdn.temasys.com.sg/skylink/skylinkjs/0.5.x/skylink.complete.min.js"></script>
    <script type="text/javascript" src="helpers.js"></script>
    <script type="text/javascript">

    var skylink = new Skylink(),
        $video = document.getElementById('myvideo'),
        $pic = document.getElementById('mypic'),
        $users = document.getElementById('users'),
        $msg = document.getElementById('msg'),
        $chatcontainer = document.getElementById('chatcontainer').children[0];
        $chatbox = document.getElementById('chatbox'),
        $photo = document.getElementById('photo'),
        $alert = document.getElementById('alert'),
        user = {},
        peer_pics = [],
        peer_audios = [],
        audioTimeouts = [],
        last_pic = null,
        capture_timeout = null;

    var online = false,
        focussed = true,
        mediaOK = false;

    var room = location.hash.length > 1 ? location.hash : 'the public hallway';

    skylink.setLogLevel(skylink.LOG_LEVEL.DEBUG);
    skylink.setDebugMode(true);

    skylink.on('incomingStream', function (peerId, stream, isSelf) {
        if(isSelf) {
            attachMediaStream($video, stream);
        }
        else {
            /*var $audio = document.createElement('audio');
            $audio.id = "audio_" + peerId;
            $audio.autoplay = true;
            $users.appendChild($audio);
            attachMediaStream($audio, stream);
            peer_audios.push($audio);*/
        }
    });

    skylink.on('incomingMessage', function (message, peerId, peerInfo, isSelf) {
        if(message.content.substr(0,1) === '/') {
            var msg = message.content.substr(1);
            if(msg === 'hail') {
                $alert.play();
                var $img = document.getElementById("img_" + peerId);
                $img.className = "hailing";
                setTimeout(function () {
                   $img.className = "";
                }, 5000);
            }
            else if(msg.substr(0,8) === 'getaroom') {
                var roomPeerId = msg.substr(9);
                var name = isSelf ? skylink.getPeerInfo(roomPeerId).userData.name : peerInfo.userData.name;

                addMessage('<a href="http://getaroom.io/' + roomPeerId + '" target="_blank">Get a meeting room with ' + name + '</a>',
                    'action', isSelf ? roomPeerId : peerId);
            }
        }
        else {
            addMessage(message.content, "message", peerId, isSelf);
        }
    });

    skylink.on('dataTransferState', function (state, transferId, peerId, transferInfo, error) {
        if(state === skylink.DATA_TRANSFER_STATE.UPLOAD_REQUEST) {
            skylink.respondBlobRequest(peerId, true);
            console.log("Incoming Request from " + peerId);
        }
        else if(state === skylink.DATA_TRANSFER_STATE.DOWNLOAD_COMPLETED) {
            console.log("Download completed from " + peerId);
            var $img = document.getElementById("img_" + peerId);

            blob2dataURL(transferInfo.data, function(data) {
                peer_pics[peerId] = data;

                if(!$img) {
                    var info = skylink.getPeerInfo(peerId);
                    $img = addUserImage(peerId, info.userData.name);
                    addMessage('is in ' + room, 'action', peerId, false);
                }

                $img.src = data;
            });
        }
        else if(error && error.message) {
            console.log(error.message);
        }
    });

    skylink.on('mediaAccessSuccess', function (stream) {
        attachMediaStream($video, stream);
        if(!user.name) {
            capture_timeout = setTimeout(capture, 2000);
            addMessage("Thanks. May I now know your name?", 'bot');
            $msg.select();
            mediaOK = true;
        }
    });

    skylink.on('mediaAccessError', function (stream) {
        addMessage("Sorry, I can't let you in like this.", 'bot');
    });

    skylink.on('peerJoined', function (peerId, peerInfo, isSelf) {
        if(isSelf) {
            online = true;
            skylink.setUserData(user);
            replay();
            addMessage('Welcome to ' + room + ', ' + user.name + '.', 'bot');
        }
    });

    skylink.on('peerLeft', function (peerId, peerInfo, isSelf) {
        if(isSelf) {
            online = false;
            addMessage('Bye', 'bot');
        }
        else {
            var $img = document.getElementById("img_" + peerId);
            var $span = document.getElementById("span_" + peerId);
            //var $audio = document.getElementById("audio_" + peerId);
            $users.removeChild($img);
            $users.removeChild($span);
            //$users.removeChild($audio);
            addMessage('left ' + room, 'action', peerId, false);
        }

    });

    skylink.init({
        //apiKey: '48f72309-6dd1-47bb-9dd2-aa43f4a6a14a',
        apiKey: '774b477f-dc20-4374-ba13-3eda09414c28',
        defaultRoom: location.hash.substr(1);
    }, function() {
        skylink.getUserMedia({
            video: {
                resolution: {
                    width: 160,
                    height: 120
                }
            },
            audio: {
                stereo: false
            }
        });
        addMessage("Hey. I\'m the office security. Please share your camera above so I can see you. <br/><br/> The coworking office is a hangout for remote workers to collaborate. It's a live-chat where you can see each other through pictures that update every 5 seconds. Additionally there are a few more things you can do: <ul><li>Your picture will blur to give you a little privacy if you're not actively following this browser tab or your window is inactive</li><li>Click on somebodies picture to hail that person</li><li>Type /hail to alert everybody in the office</li><li>Double-click somebodies picture to invite that person into a real-time audio/video meeting room</li><li>Type /clear to empty your local chat history</li><li>The chat supports <a href='https://help.github.com/articles/github-flavored-markdown/' target='_blank'>Github flavored markdown</a></li></ul>The coworking office uses WebRTC with <a href='http://temasys.github.io' target='_blank'>Skylink</a> and we don't record pictures or messages. They are send peer-to-peer directly to the other coworkers. This is a public space, so please be respectful to others.", 'bot');
    });

    function addUserImage(peerId, name) {
        var $img = document.createElement('img');
        $img.id = "img_" + peerId;
        $users.appendChild($img);

        var $span = document.createElement('span');
        $span.id = "span_" + peerId;
        $span.textContent = name;

        $span.onclick = function() {
            skylink.sendMessage('/hail', peerId);
            $img.className = "hailing";
            setTimeout(function () {
               $img.className = "";
            }, 5000);
            console.log("Hailing " + peerId);
        }
        $span.ondblclick = function () {
            skylink.sendMessage('/getaroom ' + peerId, peerId);
            console.log("Get a room invite to " + peerId);
        }

        $users.appendChild($span);

        return $img;
    }

    function addMessage(message, className, peerId, isSelf) {
        var id = (new Date()).getTime();
        var $div = document.createElement('div');
        $div.className = className + (isSelf ? 'isself': '');
        $div.id = 'msg_' + id;

        var $img = document.createElement('img');
        if(className === 'bot') {
            $img.src = 'bot.png';
        }
        else {
            $img.src = isSelf ? last_pic : peer_pics[peerId];
        }

        if($img.src) {
            $div.appendChild($img);
        }

        var $span_name = document.createElement('span');
        $span_name.className = "name";
        $span_name.textContent = className === 'bot' ? "Bot" : skylink.getPeerInfo(peerId).userData.name;
        $div.appendChild($span_name);

        var $span = document.createElement('span');
        if(className === 'action') {
            $span.innerHTML = message;
        }
        else {
            $span.innerHTML = marked(message);
        }
        $div.appendChild($span);

        if(className !== 'bot') {
            localStorage[id] = $div.outerHTML;
        }

        $chatbox.appendChild($div);

        $chatcontainer.scrollTop = $chatcontainer.scrollHeight;
    }

    function replay() {
        for(var i = 0, len = localStorage.length; i < len; i++) {
            var key = localStorage.key(i);
            if(key > (new Date()).getTime() - 1000 * 60 * 60 * 24 * 5) {
                var $div = document.createElement('div');
                $div.innerHTML = localStorage[key];
                $chatbox.appendChild($div.children[0]);
            }
        }
        $chatcontainer.scrollTop = $chatcontainer.scrollHeight;
    }

    function capture() {
        clearTimeout(capture_timeout);

        var ctx = $photo.getContext("2d");
        ctx.drawImage($video, 0, 0, 160, 120);

        if(!focussed) {
            stackBlurCanvasRGB(ctx, 0, 0, 160, 120, 35);
        }

        last_pic = $photo.toDataURL('image/jpeg', 0.8);

        $pic.src = last_pic;

        var blob = dataURL2Blob(last_pic);

        skylink.sendBlobData(blob, {
            size: blob.size,
            name: (new Date()).toString()
        });

        capture_timeout = setTimeout(capture, 5000);
    }

    function adjustVolume($audio, to) {
        if(!$audio) {
            return;
        }

        clearTimeout(audioTimeouts[$audio.id]);

        $audio.volume = $audio.volume < to ? $audio.volume += 0.05 : $audio.volume -= 0.05;

        if(Math.abs($audio.volume - to) > 0.05) {
            audioTimeouts[$audio.id] = setTimeout(function() {
                adjustVolume($audio, to);
            }, 50);
        }
    }

    function adjustAllVolume(to) {
        for(i in peer_audios) {
            peer_audios[i].volume = to;
            //adjustVolume(peer_audios[i], to);
        }
    }

    $msg.onkeydown = function(e) {
        if(!e.altKey && e.keyCode === 13 && mediaOK) {
            if(online) {
                if($msg.value === '/clear') {
                    localStorage.clear();
                    $chatbox.innerHTML = '';
                }
                else if($msg.value.substr(0,5) === '/join') {
                    window.open(location.origin + '#' + $msg.value.substr(6), $msg.value.substr(6));
                }
                else {
                    skylink.sendP2PMessage($msg.value);
                }
            }
            else if(!user.name) {
                user.name = $msg.value.replace('\n','').trim();
                skylink.joinRoom();
            }
            $msg.value = '';
            $msg.select();

            return false;
        }
    }

    $pic.onclick = function() {
        capture();
    }

    window.onfocus = function () {
        focussed = true;
        capture();
        adjustAllVolume(1);
        $msg.select();
    }

    window.onblur = function() {
        focussed = false;
        adjustAllVolume(0.2);
        capture();
    }

    </script>

</body>
</html>
